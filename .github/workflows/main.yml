name: CI/CD Pipeline - Deploy Python App to EC2

# Yeh pipeline kab chalegi: Jab 'main' branch par push ho
on:
  push:
    branches:
      - main  # Agar aapki branch ka naam 'master' hai toh isko 'master' kar dein

jobs:
  #########################################
  # JOB 1: Code ko build karega aur ECR par push karega
  #########################################
  build-and-push:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    
    # Hum ab sirf 'image_tag' pass karenge
    outputs:
      image_tag: ${{ github.sha }}

    steps:
      # Step 1: Aapka code GitHub server par layega
      - name: Check out the repo
        uses: actions/checkout@v3

      # Step 2: AWS credentials set karega (secrets se)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Step 3: ECR par login karega
      - name: Login to Amazon ECR
        id: login-ecr 
        uses: aws-actions/amazon-ecr-login@v1

      # Step 4: Docker image ko build, tag, aur push karega
      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }} 
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}     
          IMAGE_TAG: ${{ github.sha }}                    
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

  #########################################
  # JOB 2: Naye image ko EC2 par deploy karega (Safer Deployment)
  #########################################
  deploy-to-ec2:
    name: Deploy to EC2 Instance
    runs-on: ubuntu-latest
    needs: build-and-push # Yeh job pehle 'build-and-push' job ka intezar karega

    steps:
      # Step 1: SSH ke zariye EC2 par login karega aur commands chalayega
      - name: SSH into EC2 and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }} # 'ubuntu'
          key: ${{ secrets.EC2_SSH_KEY }}
          
          # Yeh script aapke EC2 server par chalegi
          script: |
            # --- BEGIN SCRIPT ---
            set -e # Agar koi command fail ho toh foran ruk jao
            
            # 1. Update server aur install dependencies
            sudo apt update -y
            sudo apt install unzip -y
            
            # 2. Install/Update AWS CLI (FIXED: --update flag add kiya hai)
            echo "Installing/Updating AWS CLI v2..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -o awscliv2.zip # -o flag overwrite karega
            sudo ./aws/install --update # --update flag pichli installation ko fix karega
            rm -rf awscliv2.zip aws
            
            # 3. AWS Account ID EC2 server se khud maloom karein
            echo "Fetching AWS Account ID..."
            TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
            AWS_ACCOUNT_ID=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/dynamic/instance-identity/document | grep accountId | awk -F'"' '{print $4}')
            
            # 4. Sahi ECR Registry URL banayein
            ECR_REGISTRY="$AWS_ACCOUNT_ID.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com"
            
            # 5. ECR par login karein
            echo "Logging into ECR at $ECR_REGISTRY..."
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY
            
            # 6. Sahi image ka naam banayein
            IMAGE_NAME="$ECR_REGISTRY/${{ secrets.ECR_REPOSITORY }}:${{ needs.build-and-push.outputs.image_tag }}"
            
            # 7. Naya image pull karein
            echo "Pulling $IMAGE_NAME"
            docker pull $IMAGE_NAME

            # 8. (NAYA STEP) Naye image ko test karein (Health Check)
            echo "Running health check on new image..."
            docker run -d --name my-python-app-test $IMAGE_NAME
            sleep 5 # Wait for 5 seconds for the app to start
            
            # Check karein ke test container abhi bhi 'running' state mein hai ya crash ho gaya
            if [ "$(docker container inspect -f '{{.State.Status}}' my-python-app-test)" != "running" ]; then
                echo "Health check FAILED! New container crashed."
                docker logs my-python-app-test
                docker rm my-python-app-test || true # Clean up test container
                exit 1 # Pipeline ko fail karein
            fi
            
            echo "Health check PASSED. New image is good."
            # Test container ko stop aur remove karein
            docker stop my-python-app-test || true
            docker rm my-python-app-test || true
            
            # 9. Ab hum purana container stop karke naya deploy karenge
            echo "Stopping old container (my-python-app)..."
            docker stop my-python-app || true
            docker rm my-python-app || true
            
            # 10. Naya container (jo pass ho chuka hai) run karein
            echo "Starting new container (my-python-app)..."
            docker run -d -p 5000:5000 --name my-python-app $IMAGE_NAME
            
            # 11. Purane images ko delete karein
            echo "Pruning old images..."
            docker image prune -a -f
